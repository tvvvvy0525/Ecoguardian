# EcoGuardian - 空地协同森林火灾应急响应仿真系统

![Python](https://img.shields.io/badge/Python-3.9+-blue.svg) ![Pygame](https://img.shields.io/badge/Pygame-2.0+-green.svg) ![NumPy](https://img.shields.io/badge/NumPy-1.20+-orange.svg)

**EcoGuardian** 是一个面向多智能体系统（Multi-Agent System, MAS）教学与研究的 2D 仿真平台。本项目模拟了一个动态的森林火灾场景，展示了**异构智能体**（无人机与无人车）如何在具有物理特性的复杂环境中进行**感知、在线学习、决策与行动**的闭环协作。

> **最新版本亮点**：引入了基于**逻辑回归 (ML)** 的效用评价模型、当前帧原子锁机制、以及具备干燥度演化的自燃环境系统，实现了从简单规则向**智能预测调度**的跨越。

---

## 📖 项目简介
在本项目中，森林环境基于**增强型元胞自动机**模拟火势。系统包含两类智能体：

1. **侦察无人机 (UAV)**：通过**蒙特卡洛采样**对全图进行紧迫度评估，主动探索久未观测的区域，通过覆盖热力图构建全局态势。
2. **消防机器人 (UGV)**：基于**在线学习预测器**评估任务成功率。具备水/电资源限制、动态 A* 路径重规划、自主任务抢占以及自动返航补给功能。

## ✨ 核心功能 (Core Features)
### 1. 🧠 机器学习驱动的效用评价 (ML-Driven Utility)
*   **在线预测器 (EfficiencyPredictor)**：系统集成了一个基于逻辑回归的在线学习模块。机器人根据任务的竞争距离差（`diff_dist`）和火场规模（`fire_size`）预测灭火成功概率。
*   **强化学习反馈**：机器人完成任务后会实时训练模型（SGD优化）。若灭火成功则标记为正样本；若中途被抢占或目标消失，则作为负样本反馈，从而动态优化未来的竞价策略。

### 2. 🛡️ 冲突解决与锁定机制
*   **当前帧原子锁 (Frame Mutex Lock)**：在主调度循环中实现，确保同一帧内多个空闲机器人不会被分配到同一个火点，解决了分布式系统常见的任务争抢问题。
*   **黑名单机制**：自动记录机器人无法到达的火点（如被障碍物包围），并在特定时间内将其列入该机器人的不可达名单，避免无效尝试。

### 3. 🔥 环境动力学增强
*   **动态干燥度系统**：树木具有动态演化的干燥度属性。干燥度随时间增长，并受环境扰动影响。
*   **自燃机制 (Spontaneous Ignition)**：当局部干燥度超过阈值，系统根据概率触发自燃，模拟真实的森林火险不确定性。
*   **风向向量计算**：火势蔓延概率受全局风向与风力因子影响，呈现出明显的传播方向性。

### 4. 🤖 智能巡逻逻辑
*   **区域紧迫度评分**：无人机不再随机飞行，而是利用“紧迫度函数”计算每个区域的漏检时长。
*   **采样优化**：通过蒙特卡洛方法采样 20 个随机点并评估其热力图得分，使无人机能快速收敛至最需要观测的灾区。

## 🛠️ 技术架构
| 模块 | 描述 | 技术/算法 |
| --- | --- | --- |
| **Environment** | 动态网格地图，含干燥度演化与风向控制。 | CA + 干燥度模型 + 向量运算 |
| **ML Module** | 任务成功率预测与在线训练。 | **逻辑回归 (Logistic Regression) + SGD** |
| **Scheduling** | 解决多智能体任务分配冲突。 | **原子锁 (Task Locking) + 效用评估** |
| **Pathfinding** | 机器人寻路与动态避障。 | **A\* 算法** |
| **Optimizer** | 预留的超参数演进框架。 | **遗传算法 (Genetic Algorithm)** |

## 🎮 操作指南
*   **界面显示说明**：
    *   **W_Diff / W_Size / Bias**：侧边栏实时显示 ML 模型当前的权重参数，可观察其随训练样本增加的演变。
    *   **Mission Log**：滚动显示系统当前的调度分配与学习状态。
*   **键盘控制**：
    *   `SPACE` (空格): **随机点火**。
    *   `R` 键: **完全重置**（重置地图、清空 ML 权重及智能体状态）。

## 📂 目录结构
```text
EcoGuardian/
├── configs/
│   └── settings.py         # 物理参数、ML超参数、颜色配置
├── core/
│   ├── grid_map.py         # 干燥度、燃料及风向逻辑
│   ├── pathfinding.py      # A* 寻路算法
│   ├── predictor.py        # [NEW] 在线学习预测模块
│   └── genetic_optimizer.py# [NEW] 遗传算法框架
├── agents/
│   ├── drone.py            # 无人机巡逻 (紧迫度采样)
│   └── robot.py            # 机器人 (成功率评估、反馈训练)
├── main.py                 # 全局原子锁调度与渲染循环
└── ...
```

## 🚀 后续扩展方向 (Future Work)
1. **遗传算法演进**：利用 `genetic_optimizer.py` 自动进化智能体的拥挤惩罚参数。
2. **多机协同补给**：增加运载智能体，为前线机器人提供动态水/电接力补给。
3. **分布式模型共享**：实现多智能体之间的权重同步，加速群体学习过程。
