# EcoGuardian - 空地协同森林火灾应急响应仿真系统

![Python](https://img.shields.io/badge/Python-3.9+-blue.svg) ![Pygame](https://img.shields.io/badge/Pygame-2.0+-green.svg) ![NumPy](https://img.shields.io/badge/NumPy-1.20+-orange.svg)

**EcoGuardian** 是一个面向多智能体系统（Multi-Agent System, MAS）教学与研究的 2D 仿真平台。本项目模拟了一个动态的森林火灾场景，展示了**异构智能体**（无人机与无人车）如何在具有物理特性的复杂环境中进行**感知、通信、决策与行动**的闭环协作。

> **最新版本亮点**：引入了全局任务锁机制与局部连续作战逻辑，大幅解决了智能体扎堆与调度冲突问题，并实现了精准的救援效率统计。

---

## 📖 项目简介
在本项目中，森林环境基于**增强型元胞自动机**模拟火势。系统包含两类智能体：

1. **侦察无人机 (UAV)**：基于覆盖热力图进行智能巡逻，主动探索未知或久未观测的区域，构建全局态势感知。
2. **消防机器人 (UGV)**：具有水与电量限制，能够执行动态路径重规划、自主任务抢占，并在资源不足或长期空闲时自动返回补给站。

系统演示了“空地协同”模式：无人机建立全局热力图并发现火源，指挥中心基于**全局锁定策略**调度机器人，机器人利用 **A\* 算法** 规划路径、动态避障并完成灭火任务。

## ✨ 核心功能 (Core Features)
### 1. 🛡️ 高级协同调度 (Advanced Coordination)
* **全局任务锁 (Global Task Locking)**：
  * 主循环实现了防争抢逻辑。在分配任务前，系统会检查火源是否已被其他正在移动的机器人“锁定”，防止多个机器人同时奔赴同一远距离目标，极大提升了调度效率。


* **局部连续作战 (Local Chain Reaction)**：
  * 机器人在完成灭火任务后，会自动扫描周围（3x3区域）。若发现紧邻的火源，将触发**自主抢占**机制，无需经过中央调度直接就地灭火，减少往返跑动。



### 2. 🔥 增强物理环境
* **动态风向**：仿真启动时随机生成风向（如西北风、南风），火势蔓延具有方向性偏好。
* **状态演变**：严格区分**自然烧毁**（State 4, 燃料耗尽）与**人工扑灭**（State 6, 机器人干预），以此计算真实的救援效率。

### 3. 🤖 智能体生存与鲁棒性
* **资源闭环**：机器人拥有**电量**（移动消耗）和**水量**（灭火消耗）。
* **自动补给**：当资源低于阈值或长期无任务时，机器人自动规划路径前往**补给站（Depot）**。
* **防错机制**：
  * **防隔空灭火**：引入坐标双重校验，确保机器人必须物理到达目标点才能执行灭火操作。
  * **动态重规划**：移动中若路径被新蔓延的火势阻挡，立即触发 A* 重规划。



### 4. 📊 实时数据可视化
* **侧边栏增强**：实时显示风向、救援效率（Efficiency），并集成了**滚动式任务日志 (Mission Log)**，实时追踪调度指令。

## 🛠️ 技术架构
| 模块 | 描述 | 技术/算法 |
| --- | --- | --- |
| **Environment** | 40x30 网格地图，含树、火、墙、焦土、补给站。 | CA + 风向向量计算 + 燃料衰减 |
| **Perception** | 无人机维护全局“扫描热力图”，寻找高紧迫度区域。 | 蒙特卡洛采样 + 覆盖率衰减 |
| **Scheduling** | **解决多智能体任务分配冲突**。 | **全局任务锁 (Task Locking) + 竞价机制** |
| **Action** | 机器人寻路、避障与自主决策。 | **A\* 算法** + **局部链式反应** + FSM |
| **Visualization** | 渲染循环与交互 UI。 | Python / Pygame (自适应布局) |

## 🎮 操作指南
仿真启动后，您将看到网格地图和智能体自动运行。

* **键盘控制**：
  * `SPACE` (空格): **随机点火**。手动在地图上增加火源，测试智能体反应速度。
  * `R` 键: **完全重置**。重新生成地图、随机风向及智能体位置。


* **界面说明**：
  * 🟦 **蓝色方块**：侦察无人机 (UAV)。
  * 🟨 **金色方块**：消防机器人 (UGV) - *灭火时会有橙色状态框*。
  * 🟪 **紫色方块**：补给站 (Depot) - 机器人回血回蓝的地方。
  * 🟥 **红色**：正在蔓延的火源 / ⬛ **黑色**：自然烧毁 / 🟦 **深蓝**：人工扑灭。
* **侧边栏**：包含任务日志、效率统计及风力信息。



## 📂 目录结构
```text
EcoGuardian/
├── assets/                 # 资源文件夹
├── configs/
│   └── settings.py         # 全局配置 (物理参数, 资源阈值, 颜色)
├── core/
│   ├── grid_map.py         # 地图类 (含风向、燃料、状态演变逻辑)
│   └── pathfinding.py      # A* 寻路算法 (支持动态障碍)
├── agents/
│   ├── base_agent.py       # 智能体基类
│   ├── drone.py            # UAV 智能巡逻逻辑 (热力图采样)
│   └── robot.py            # UGV 逻辑 (连续作战、防错校验、资源管理)
├── main.py                 # 程序入口 (主循环、全局调度器、UI渲染)
└── requirements.txt        # 依赖列表

```

## 🚀 后续扩展方向 (Future Work)
1. **强化学习 (RL)**：将现有环境封装为 Gym 接口，训练 UAV 预测火势走向以优化覆盖策略。
2. **复杂通信**：引入通信距离限制，模拟真实世界的信号衰减，实现分布式协同。
3. **异构协作增强**：增加“运水无人机”，允许无人机为地面机器人进行空中补给。